<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genie Presentations - Gerador de Apresenta√ß√µes com IA</title>
    
    <!-- Carrega o Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carrega as bibliotecas necess√°rias que se tornar√£o vari√°veis globais -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Adiciona a biblioteca JSZip, que √© uma depend√™ncia do PptxGenJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.min.js"></script>
    
    <!-- Carrega o Babel para transpilar o JSX diretamente no navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Adiciona uma fonte mais agrad√°vel para a aplica√ß√£o */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Anima√ß√£o para o surgimento dos slides */
        .slide-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Estilos para o loader de IA */
        .loader-sm {
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.6s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- O elemento raiz onde o aplicativo React ser√° montado -->
    <div id="root"></div>

    <!-- O script do aplicativo React, com o tipo "text/babel" para que o Babel o processe -->
    <script type="text/babel">
        // Desestruturando as fun√ß√µes do objeto global React
        const { useState, useRef, useEffect } = React;

        // --- √çcones como Componentes SVG ---
        const Icon = ({ path, className }) => (<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>{path}</svg>);
        const Bars3Icon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M3 6.75A.75.75 0 0 1 3.75 6h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 6.75ZM3 12a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75A.75.75 0 0 1 3 12Zm0 5.25a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75Z" clipRule="evenodd" />} />;
        const ArrowDownTrayIcon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.69l3.22-3.22a.75.75 0 1 1 1.06 1.06l-4.5 4.5a.75.75 0 0 1-1.06 0l-4.5-4.5a.75.75 0 1 1 1.06-1.06l3.22 3.22V3a.75.75 0 0 1 .75-.75Zm-9 13.5a.75.75 0 0 1 .75.75v2.25a1.5 1.5 0 0 0 1.5 1.5h13.5a1.5 1.5 0 0 0 1.5-1.5V16.5a.75.75 0 0 1 1.5 0v2.25a3 3 0 0 1-3 3H5.25a3 3 0 0 1-3-3V16.5a.75.75 0 0 1 .75-.75Z" clipRule="evenodd" />} />;
        const SparklesIcon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M9.344 3.071a.75.75 0 0 1 1.06 0l2.5 2.5a.75.75 0 0 1 0 1.06l-2.5 2.5a.75.75 0 0 1-1.06-1.06L10.94 6l-1.595-1.595a.75.75 0 0 1 0-1.06l-.001-.001ZM12 1.5a.75.75 0 0 1 .75.75v2.25a.75.75 0 0 1-1.5 0V2.25A.75.75 0 0 1 12 1.5ZM16.06 4.939a.75.75 0 0 1 0 1.06l-1.75 1.75a.75.75 0 0 1-1.06-1.06l1.75-1.75a.75.75 0 0 1 1.06 0ZM21.75 12a.75.75 0 0 1-.75.75h-2.25a.75.75 0 0 1 0-1.5h2.25a.75.75 0 0 1 .75.75ZM16.06 17.96a.75.75 0 0 1 1.06 0l1.75 1.75a.75.75 0 1 1-1.06 1.06l-1.75-1.75a.75.75 0 0 1 0-1.06ZM12 22.5a.75.75 0 0 1-.75-.75v-2.25a.75.75 0 0 1 1.5 0v2.25a.75.75 0 0 1-.75.75ZM4.939 16.06a.75.75 0 0 1 1.06 0l1.75 1.75a.75.75 0 0 1-1.06 1.06l-1.75-1.75a.75.75 0 0 1 0-1.06ZM2.25 12c0 .414.336.75.75.75h2.25a.75.75 0 0 0 0-1.5H3a.75.75 0 0 0-.75.75ZM4.939 7.939a.75.75 0 0 1-1.06 0L2.129 6.189a.75.75 0 1 1 1.06-1.06l1.75 1.75a.75.75 0 0 1 0 1.06ZM12 12.75a.75.75 0 0 0-1.06-.02l-1.313-1.313a.75.75 0 0 1 1.06-1.06l1.313 1.313a.75.75 0 0 0 .02 1.06Zm-4.243-4.242a.75.75 0 0 0-1.06-1.06l-1.313 1.313a.75.75 0 0 0 1.06 1.06l1.313-1.313Z" clipRule="evenodd" />} />;
        const XMarkIcon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clipRule="evenodd" />} />;
        const TrashIcon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M16.5 4.478v.227a48.816 48.816 0 0 1-3.878.512.75.75 0 1 1-.256-1.478l3.585-.616a.75.75 0 0 1 .848.848Zm-4.219 1.585a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-1.5 0V6.813a.75.75 0 0 1 .75-.75Zm2.25 0a.75.75 0 0 1 .75.75v10.5a.75.75 0 0 1-1.5 0V6.813a.75.75 0 0 1 .75-.75Z" clipRule="evenodd" />} />;
        const PhotoIcon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M1.5 6a2.25 2.25 0 0 1 2.25-2.25h16.5A2.25 2.25 0 0 1 22.5 6v12a2.25 2.25 0 0 1-2.25 2.25H3.75A2.25 2.25 0 0 1 1.5 18V6ZM3 16.06l4.22-4.22a.75.75 0 0 1 1.06 0l3.53 3.53a.75.75 0 0 0 1.06 0l2.12-2.12a.75.75 0 0 1 1.06 0l3.18 3.18V6H3v10.06ZM12 9a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Z" clipRule="evenodd" />} />;
        const ArrowUpOnSquareIcon = (props) => <Icon {...props} path={<path fillRule="evenodd" d="M9 3.75a.75.75 0 0 1 .75.75v6.586l1.97-1.97a.75.75 0 0 1 1.06 1.06l-3.25 3.25a.75.75 0 0 1-1.06 0L5.22 9.126a.75.75 0 0 1 1.06-1.06l1.97 1.97V4.5a.75.75 0 0 1 .75-.75Zm2.25 8.25a.75.75 0 0 1 .75.75v3.75a.75.75 0 0 1-1.5 0V12.75a.75.75 0 0 1 .75-.75Z" clipRule="evenodd" />} />;
        const PencilSquareIcon = (props) => <Icon {...props} path={<path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />} />;

        // Dados dos ODS (apenas texto)
        const odsData = [
            { id: 1, name: '1: Erradica√ß√£o da Pobreza' }, { id: 2, name: '2: Fome Zero' },
            { id: 3, name: '3: Sa√∫de e Bem-Estar' }, { id: 4, name: '4: Educa√ß√£o de Qualidade' },
            { id: 5, name: '5: Igualdade de G√™nero' }, { id: 6, name: '6: √Ågua Pot√°vel e Saneamento' },
            { id: 7, name: '7: Energia Limpa e Acess√≠vel' }, { id: 8, name: '8: Trabalho Decente' },
            { id: 9, name: '9: Inova√ß√£o e Infraestrutura' }, { id: 10, name: '10: Redu√ß√£o das Desigualdades' },
            { id: 11, name: '11: Cidades Sustent√°veis' }, { id: 12, name: '12: Consumo Respons√°vel' },
            { id: 13, name: '13: A√ß√£o Clim√°tica' }, { id: 14, name: '14: Vida na √Ågua' },
            { id: 15, name: '15: Vida Terrestre' }, { id: 16, name: '16: Paz e Justi√ßa' },
            { id: 17, name: '17: Parcerias' },
        ];

        function App() {
            const [projectText, setProjectText] = useState(() => localStorage.getItem('projectText') || '');
            const [slides, setSlides] = useState([]);
            const [theme, setTheme] = useState(null);
            const [userImages, setUserImages] = useState([]);
            const [logo, setLogo] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [errorMessage, setErrorMessage] = useState('');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [includeImageCounterparts, setIncludeImageCounterparts] = useState(false);
            const [includeSocialCounterparts, setIncludeSocialCounterparts] = useState(false);
            const [includeInvestmentPlan, setIncludeInvestmentPlan] = useState(false);
            const [includeAiImages, setIncludeAiImages] = useState(true);
            const [sponsorInfo, setSponsorInfo] = useState('');
            const [phone, setPhone] = useState('');
            const [email, setEmail] = useState('');
            const [website, setWebsite] = useState('');
            const [socialMedia, setSocialMedia] = useState('');
            const [selectedODS, setSelectedODS] = useState([]);
            const [themeDescription, setThemeDescription] = useState('');
            const [refiningState, setRefiningState] = useState({}); // { [slideIndex]: 'tone' | true }

            useEffect(() => {
                localStorage.setItem('projectText', projectText);
            }, [projectText]);

            const handleImageUpload = (event, isLogo = false) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;

                if (isLogo) {
                    const file = files[0];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setLogo({ name: file.name, data: e.target.result, type: file.type });
                    };
                    reader.readAsDataURL(file);
                } else {
                    const imagePromises = files.map(file => {
                        return new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve({ name: file.name, data: e.target.result, type: file.type });
                            reader.readAsDataURL(file);
                        });
                    });

                    Promise.all(imagePromises).then(newImages => {
                        setUserImages(prev => [...prev, ...newImages]);
                    });
                    setIncludeAiImages(false);
                }
            };

            const toggleODS = (id) => {
                setSelectedODS(prev => 
                    prev.includes(id) ? prev.filter(odsId => odsId !== id) : [...prev, id]
                );
            };

            const generateImagesForSlides = async (slidesWithPrompts) => {
                for (let i = 0; i < slidesWithPrompts.length; i++) {
                    const slide = slidesWithPrompts[i];
                    if (slide.image_prompt) {
                        try {
                            const imagePayload = { instances: [{ prompt: slide.image_prompt }], parameters: { "sampleCount": 1 } };
                            const apiKey = "";
                            const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
                            const imageResponse = await fetch(imageUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(imagePayload) });
                            if (!imageResponse.ok) continue;
                            
                            const imageResult = await imageResponse.json();
                            const base64ImageData = imageResult.predictions[0]?.bytesBase64Encoded;

                            if (base64ImageData) {
                                setSlides(prevSlides => {
                                    const newSlides = [...prevSlides];
                                    if(newSlides[i]) newSlides[i].imageData = `data:image/png;base64,${base64ImageData}`;
                                    return newSlides;
                                });
                            }
                        } catch (error) {
                            console.error(`Erro ao gerar imagem para o slide ${i + 1}:`, error);
                        }
                    }
                }
            };
            
            const callGeminiAPI = async (prompt, isJson = false) => {
                let promptParts = [{ text: prompt }];
                
                const payload = {
                    contents: [{ role: "user", parts: promptParts }],
                };

                if (isJson) {
                    payload.generationConfig = {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "theme": { type: "OBJECT", properties: { "primaryColor": { "type": "STRING" }, "textColor": { "type": "STRING" }, "backgroundColor": { "type": "STRING" } }, required: ["primaryColor", "textColor", "backgroundColor"] },
                                "slides": { type: "ARRAY", items: { type: "OBJECT", properties: { "title": { "type": "STRING" }, "content": { "type": "STRING" }, "image_prompt": { "type": "STRING" }, "notes": {"type": "STRING"} }, required: ["title", "content"] } }
                            },
                            required: ["theme", "slides"]
                        }
                    };
                }
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
                
                const result = await response.json();
                const text = result.candidates[0]?.content?.parts?.[0]?.text;
                if (!text) throw new Error('A resposta da IA est√° vazia.');
                
                return text;
            };


            const generatePreview = async () => {
                setIsLoading(true);
                setErrorMessage('');
                setSlides([]);
                setTheme(null);

                if (!projectText.trim()) {
                    setErrorMessage('Por favor, insira o texto do projeto.');
                    setIsLoading(false);
                    return;
                }

                try {
                    let basePrompt = `Voc√™ √© um especialista em criar propostas comerciais para ONGs. Sua tarefa √© transformar o texto de um projeto em uma apresenta√ß√£o estrat√©gica e persuasiva. **Seja conciso e direto. Use frases curtas e bullet points.**`;
                    
                    if (logo || themeDescription) {
                        basePrompt += `\n\nAnalise a identidade visual.`;
                        if (themeDescription) basePrompt += ` O usu√°rio descreveu o estilo como: "${themeDescription}".`;
                        if (logo) basePrompt += ` A logomarca tamb√©m foi fornecida para refer√™ncia de cores.`;
                        basePrompt += ` Baseado nisso, sugira um tema de design.`;
                    }
                    
                    basePrompt += `\n\nSua resposta deve ser um objeto JSON. A estrutura deve ser: { "theme": { "primaryColor": "#XXXXXX", "textColor": "#XXXXXX", "backgroundColor": "#XXXXXX" }, "slides": [ { "title": "...", "content": "...", "image_prompt": "...", "notes": "..." } ] }. O campo "notes" deve conter sugest√µes de roteiro para o apresentador em bullet points.`;
                    
                    let imagePromptInstruction = (includeAiImages && userImages.length === 0)
                        ? `Para cada slide, inclua um campo "image_prompt" no JSON com uma descri√ß√£o em ingl√™s para uma IA gerar uma imagem simb√≥lica e limpa (estilo: 'digital art, clean, minimalist').`
                        : '';

                    let slideCounter = 5;
                    let optionalSlidesPrompt = `\n\n${imagePromptInstruction}\n\n**Estrutura da Apresenta√ß√£o:**\n1. Capa\n2. O Problema\n3. A Solu√ß√£o\n4. Diferenciais\n5. Impacto Esperado`;
                    
                    if (selectedODS.length > 0) {
                        slideCounter++;
                        const selectedODSNames = selectedODS.map(id => odsData.find(ods => ods.id === id).name).join(', ');
                        optionalSlidesPrompt += `\n${slideCounter}. **Alinhamento com os ODS:** Crie um slide com este t√≠tulo, explicando como o projeto se alinha com: ${selectedODSNames}.`;
                    }
                    if (sponsorInfo.trim()) {
                        slideCounter++;
                        optionalSlidesPrompt += `\n${slideCounter}. **Alinhamento Estrat√©gico:** Crie um slide com este t√≠tulo, conectando o projeto aos valores da empresa patrocinadora.`;
                    }
                    if (includeImageCounterparts) { slideCounter++; optionalSlidesPrompt += `\n${slideCounter}. Contrapartidas de Visibilidade`; }
                    if (includeSocialCounterparts) { slideCounter++; optionalSlidesPrompt += `\n${slideCounter}. Valor para a Marca (ESG)`; }
                    if (includeInvestmentPlan) { slideCounter++; optionalSlidesPrompt += `\n${slideCounter}. Plano de Investimento`; }
                    
                    let contactInfoPrompt = '';
                    if (phone || email || website || socialMedia) {
                        contactInfoPrompt += '\n\n**Informa√ß√µes de Contato da ONG para incluir no √∫ltimo slide (use emojis como √≠cones):**';
                        if (phone) contactInfoPrompt += `\n- üìû Telefone: ${phone}`;
                        if (email) contactInfoPrompt += `\n- üìß E-mail: ${email}`;
                        if (website) contactInfoPrompt += `\n- üåê Site: ${website}`;
                        if (socialMedia) contactInfoPrompt += `\n- üîó Rede Social: ${socialMedia}`;
                    }
                    
                    slideCounter++;
                    const finalPromptPart = `\n${slideCounter}. **Chamada para A√ß√£o:** T√≠tulo 'Junte-se a N√≥s'. O conte√∫do deve ser um convite para parceria e incluir as informa√ß√µes de contato se fornecidas.\n${contactInfoPrompt}\n\n**Informa√ß√µes do Projeto:**\n\`\`\`${projectText}\`\`\`\n\n**Informa√ß√µes do Patrocinador para personaliza√ß√£o:**\n\`\`\`${sponsorInfo}\`\`\``;
                    
                    let fullPrompt = basePrompt + optionalSlidesPrompt + finalPromptPart;

                    let promptParts = [{ text: fullPrompt }];
                    if (logo) {
                        const mimeType = logo.type;
                        const base64Data = logo.data.substring(logo.data.indexOf(",") + 1);
                        promptParts.push({ inlineData: { mimeType: mimeType, data: base64Data } });
                    }
                    
                    const payload = {
                        contents: [{ role: "user", parts: promptParts }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "theme": { type: "OBJECT", properties: { "primaryColor": { "type": "STRING" }, "textColor": { "type": "STRING" }, "backgroundColor": { "type": "STRING" } }, required: ["primaryColor", "textColor", "backgroundColor"] },
                                    "slides": { type: "ARRAY", items: { type: "OBJECT", properties: { "title": { "type": "STRING" }, "content": { "type": "STRING" }, "image_prompt": { "type": "STRING" }, "notes": {"type": "STRING"} }, required: ["title", "content"] } }
                                },
                                required: ["theme", "slides"]
                            }
                        }
                    };

                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`Erro na API de texto: ${response.statusText}`);
                    
                    const result = await response.json();
                    const jsonText = result.candidates[0]?.content?.parts?.[0]?.text;
                    if (!jsonText) throw new Error('A resposta da IA n√£o cont√©m dados JSON v√°lidos.');

                    const presentationData = JSON.parse(jsonText);
                    
                    if (!presentationData || !Array.isArray(presentationData.slides)) {
                        console.error("Resposta da IA inv√°lida. 'slides' n√£o √© um array:", jsonText);
                        throw new Error('A IA retornou um formato de dados inesperado. Tente novamente.');
                    }
                    
                    if (userImages.length > 0) {
                        presentationData.slides.forEach((slide, index) => {
                            if (userImages[index % userImages.length]) {
                                slide.imageData = userImages[index % userImages.length].data;
                            }
                        });
                    }
                    
                    setSlides(presentationData.slides);
                    setTheme(presentationData.theme);

                    if (includeAiImages && userImages.length === 0) {
                        generateImagesForSlides(presentationData.slides);
                    }

                } catch (error) {
                    console.error('Erro geral na gera√ß√£o da apresenta√ß√£o:', error);
                    setErrorMessage(`Ocorreu um erro: ${error.message}`);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const refineSlideContent = async (index, tone) => {
                setRefiningState(prev => ({ ...prev, [index]: tone }));
                try {
                    const slide = slides[index];
                    const prompt = `Reescreva o seguinte conte√∫do de slide para ter um tom mais **${tone}**. Retorne apenas o texto reescrito, sem o t√≠tulo ou formata√ß√£o adicional.\n\nConte√∫do original:\n"${slide.content}"`;
                    const newContent = await callGeminiAPI(prompt);
                    handleSlideChange(index, 'content', newContent);
                } catch (error) {
                    setErrorMessage(`Erro ao refinar: ${error.message}`);
                } finally {
                    setRefiningState(prev => ({ ...prev, [index]: false }));
                }
            };

            const generatePresenterNotes = async (index) => {
                setRefiningState(prev => ({ ...prev, [`notes-${index}`]: true }));
                try {
                    const slide = slides[index];
                    const prompt = `Crie notas de apresentador (em portugu√™s) para um slide com o t√≠tulo "${slide.title}" e conte√∫do "${slide.content}". As notas devem ser curtas, em bullet points, e fornecer dicas e contexto para o apresentador. Retorne apenas as notas.`;
                    const newNotes = await callGeminiAPI(prompt);
                    handleSlideChange(index, 'notes', newNotes);
                } catch (error) {
                    setErrorMessage(`Erro ao gerar notas: ${error.message}`);
                } finally {
                    setRefiningState(prev => ({ ...prev, [`notes-${index}`]: false }));
                }
            };

            const createAndDownloadPowerPoint = () => {
                const pptx = new PptxGenJS();
                pptx.layout = 'LAYOUT_WIDE';
                
                const THEME = theme ? {
                    background: theme.backgroundColor.replace('#', ''),
                    text: theme.textColor.replace('#', ''),
                    accent: theme.primaryColor.replace('#', ''),
                } : {
                    background: 'FFFFFF',
                    text: '334155',
                    accent: '4F46E5',
                };

                slides.forEach((slide, index) => {
                    const newSlide = pptx.addSlide();
                    newSlide.background = { color: THEME.background };
                    if (slide.notes) {
                        newSlide.addNotes(slide.notes);
                    }
                    
                    if (logo && index !== 0) {
                        newSlide.addImage({
                            data: logo.data, x: 9.0, y: 0.15, w: 0.8, h: 0.4,
                            sizing: { type: 'contain' }
                        });
                    }

                    if (index === 0) {
                        if (slide.imageData) {
                            newSlide.addImage({ data: slide.imageData, x: 0, y: 0, w: '100%', h: '100%', sizing: { type: 'cover' } });
                            newSlide.addShape(pptx.shapes.RECTANGLE, { x: 0, y: 0, w: '100%', h: '100%', fill: { color: '000000', transparency: 50 } });
                        }
                        newSlide.addText(slide.title, { x: 0.5, y: 2, w: '90%', h: 1, align: 'center', fontSize: 48, fontFace: 'Inter', color: 'FFFFFF', bold: true });
                        newSlide.addText(slide.content, { x: 0.5, y: 3, w: '90%', h: 0.5, align: 'center', fontSize: 24, fontFace: 'Inter', color: 'FFFFFF', italic: true });
                        return;
                    }
                    
                    if (index === slides.length - 1) {
                        newSlide.background = { color: THEME.accent };
                        newSlide.addText(slide.title, { x: 0.5, y: 1.5, w: '90%', h: 1, align: 'center', fontSize: 40, fontFace: 'Inter', color: 'FFFFFF', bold: true });
                        const contentPoints = slide.content.split('\n').filter(line => line.trim() !== '');
                        const formattedContent = contentPoints.map(point => ({ text: point, options: { align: 'center', fontFace: 'Inter', fontSize: 18, color: 'FFFFFF' } }));
                        newSlide.addText(formattedContent, { x: 0.5, y: 2.5, w: '90%', h: 2 });
                        return;
                    }

                    const layoutType = index % 3;
                    
                    if (layoutType === 1) {
                        const textX = 0.5, imageX = 5.5;
                        if (slide.imageData) newSlide.addImage({ data: slide.imageData, x: imageX, y: 1.25, w: 4, h: 3.125, sizing: { type: 'cover' } });
                        newSlide.addText(slide.title, { x: textX, y: 1.5, w: 4.5, h: 1, fontSize: 36, fontFace: 'Inter', color: THEME.accent, bold: true });
                        const contentPoints = slide.content.split('\n').filter(line => line.trim() !== '');
                        newSlide.addText(contentPoints.join('\n'), { x: textX, y: 2.5, w: 4.5, h: 2.5, fontSize: 18, fontFace: 'Inter', color: THEME.text, bullet: { type: 'dot', color: THEME.accent } });
                    } else if (layoutType === 2) {
                        const textX = 5.5, imageX = 0.5;
                        if (slide.imageData) newSlide.addImage({ data: slide.imageData, x: imageX, y: 1.25, w: 4, h: 3.125, sizing: { type: 'cover' } });
                        newSlide.addText(slide.title, { x: textX, y: 1.5, w: 4, h: 1, fontSize: 36, fontFace: 'Inter', color: THEME.accent, bold: true });
                        const contentPoints = slide.content.split('\n').filter(line => line.trim() !== '');
                        newSlide.addText(contentPoints.join('\n'), { x: textX, y: 2.5, w: 4, h: 2.5, fontSize: 18, fontFace: 'Inter', color: THEME.text, bullet: { type: 'dot', color: THEME.accent } });
                    } else {
                        newSlide.addShape(pptx.shapes.RECTANGLE, { x: 0, y: 0, w: '100%', h: 1.25, fill: { color: THEME.accent } });
                        newSlide.addText(slide.title, { x: 0.5, y: 0, w: '90%', h: 1.25, align: 'left', valign: 'middle', fontSize: 32, fontFace: 'Inter', color: 'FFFFFF', bold: true });
                        if (slide.imageData) newSlide.addImage({ data: slide.imageData, x: 5.5, y: 1.75, w: 4, h: 3, sizing: { type: 'cover' } });
                        const contentPoints = slide.content.split('\n').filter(line => line.trim() !== '');
                        newSlide.addText(contentPoints.join('\n'), { x: 0.5, y: 1.75, w: 4.5, h: 3, fontSize: 18, fontFace: 'Inter', color: THEME.text, bullet: { type: 'dot', color: THEME.accent } });
                    }
                });
                
                pptx.writeFile({ fileName: 'Apresentacao-Projeto-ONG.pptx' });
            };
            
            const handleSlideChange = (index, field, value) => {
                const updatedSlides = [...slides];
                if(updatedSlides[index]) {
                    updatedSlides[index][field] = value;
                    setSlides(updatedSlides);
                }
            };
            
            const clearAll = () => {
                setProjectText(''); setSlides([]); setErrorMessage('');
                setUserImages([]); setLogo(null);
            }

            return (
                <div className="min-h-screen text-gray-800 flex flex-col lg:flex-row">
                    <aside className={`fixed inset-y-0 left-0 transform ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out z-50 w-80 bg-white border-r border-gray-200 shadow-xl lg:shadow-none p-6 flex flex-col`}>
                        <div className="flex-1 overflow-y-auto pr-2">
                            <div className="flex items-center justify-between lg:mb-8 mb-4">
                                <div className="flex items-center space-x-3"><SparklesIcon className="h-8 w-8 text-indigo-600" /><h1 className="text-xl font-bold tracking-tight text-gray-900">Genie Presentations</h1></div>
                                <button onClick={() => setIsSidebarOpen(false)} className="lg:hidden text-gray-500 hover:text-gray-900"><XMarkIcon className="h-6 w-6" /></button>
                            </div>
                            <p className="text-sm text-gray-500 mb-6">Insira o texto do seu projeto e a IA criar√° uma pr√©via edit√°vel da sua apresenta√ß√£o.</p>
                            <div className="space-y-4">
                                <div className="relative">
                                    <textarea value={projectText} onChange={(e) => setProjectText(e.target.value)} placeholder="Cole o texto do seu projeto aqui..." className="w-full h-28 p-4 text-sm text-gray-700 bg-gray-50 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                                     {projectText && <button onClick={clearAll} className="absolute top-2 right-2 text-gray-400 hover:text-gray-600"><TrashIcon className="h-5 w-5" /></button>}
                                </div>
                                
                                <div className="border-t border-gray-200 pt-4">
                                    <h3 className="text-sm font-semibold text-gray-600 mb-3">Identidade Visual</h3>
                                    <input type="text" value={themeDescription} onChange={(e) => setThemeDescription(e.target.value)} placeholder="Descreva o estilo (ex: moderno, corporativo)" className="w-full p-2 text-sm border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 mb-2" />
                                    <label htmlFor="logo-upload" className="w-full cursor-pointer bg-gray-50 hover:bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors duration-200 border border-dashed border-gray-300">
                                        <ArrowUpOnSquareIcon className="h-5 w-5" /><span>Upload da Logomarca</span>
                                    </label>
                                    <input id="logo-upload" type="file" className="hidden" accept="image/*" onChange={(e) => handleImageUpload(e, true)} />
                                    {logo && <img src={logo.data} className="h-16 mx-auto mt-2 object-contain" />}
                                </div>

                                <div className="border-t border-gray-200 pt-4">
                                    <h3 className="text-sm font-semibold text-gray-600 mb-3">Imagens da Apresenta√ß√£o</h3>
                                     <label htmlFor="image-upload" className="w-full cursor-pointer bg-gray-50 hover:bg-gray-100 text-gray-700 font-semibold py-3 px-4 rounded-lg flex items-center justify-center space-x-2 transition-colors duration-200 border border-dashed border-gray-300">
                                        <ArrowUpOnSquareIcon className="h-5 w-5" /><span>Upload de Fotos</span>
                                    </label>
                                    <input id="image-upload" type="file" className="hidden" accept="image/*" multiple onChange={(e) => handleImageUpload(e, false)} />
                                    <div className="mt-2 grid grid-cols-3 gap-2">
                                        {userImages.map((img, i) => <img key={i} src={img.data} className="h-16 w-full object-cover rounded-md" title={img.name} />)}
                                    </div>
                                    <label className="flex items-center space-x-2 text-sm text-gray-700 mt-3">
                                        <input type="checkbox" checked={includeAiImages} onChange={(e) => setIncludeAiImages(e.target.checked)} disabled={userImages.length > 0} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:bg-gray-200" />
                                        <span>Gerar imagens com IA</span>
                                    </label>
                                </div>
                                
                                <div className="border-t border-gray-200 pt-4">
                                    <h3 className="text-sm font-semibold text-gray-600 mb-3">Personaliza√ß√£o para Patrocinador</h3>
                                    <textarea value={sponsorInfo} onChange={(e) => setSponsorInfo(e.target.value)} placeholder="Cole aqui a miss√£o, valores ou infos de ESG da empresa alvo..." className="w-full h-24 p-2 text-sm border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" />
                                </div>

                                <div className="border-t border-gray-200 pt-4">
                                    <h3 className="text-sm font-semibold text-gray-600 mb-3">ODS (Objetivos de Desenvolvimento Sustent√°vel)</h3>
                                    <div className="space-y-2 max-h-32 overflow-y-auto">
                                        {odsData.map(ods => (
                                            <label key={ods.id} className="flex items-center space-x-2 text-sm text-gray-700">
                                                <input type="checkbox" checked={selectedODS.includes(ods.id)} onChange={() => toggleODS(ods.id)} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" />
                                                <span>{ods.name}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="border-t border-gray-200 pt-4">
                                    <h3 className="text-sm font-semibold text-gray-600 mb-3">Conte√∫do Adicional</h3>
                                    <div className="space-y-2">
                                        <label className="flex items-center space-x-2 text-sm text-gray-700"><input type="checkbox" checked={includeImageCounterparts} onChange={() => setIncludeImageCounterparts(!includeImageCounterparts)} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" /><span>Contrapartidas de Visibilidade</span></label>
                                        <label className="flex items-center space-x-2 text-sm text-gray-700"><input type="checkbox" checked={includeSocialCounterparts} onChange={() => setIncludeSocialCounterparts(!includeSocialCounterparts)} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" /><span>Valor para Marca (ESG)</span></label>
                                        <label className="flex items-center space-x-2 text-sm text-gray-700"><input type="checkbox" checked={includeInvestmentPlan} onChange={() => setIncludeInvestmentPlan(!includeInvestmentPlan)} className="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500" /><span>Plano de Investimento</span></label>
                                    </div>
                                </div>

                                <div className="border-t border-gray-200 pt-4">
                                    <h3 className="text-sm font-semibold text-gray-600 mb-3">Informa√ß√µes de Contato</h3>
                                    <div className="space-y-2">
                                        <input type="tel" placeholder="Telefone" value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full p-2 text-sm border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" />
                                        <input type="email" placeholder="E-mail" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full p-2 text-sm border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" />
                                        <input type="url" placeholder="Site" value={website} onChange={(e) => setWebsite(e.target.value)} className="w-full p-2 text-sm border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" />
                                        <input type="url" placeholder="Rede Social (link)" value={socialMedia} onChange={(e) => setSocialMedia(e.target.value)} className="w-full p-2 text-sm border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500" />
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="pt-6 space-y-3">
                             <button onClick={generatePreview} disabled={isLoading || !projectText.trim()} className="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-lg hover:bg-indigo-700 transition-all duration-200 disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:scale-105">
                                {isLoading ? (<svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>) : (<> <SparklesIcon className="h-5 w-5" /><span>Gerar Pr√©via</span></>)}
                            </button>
                            {slides.length > 0 && (
                                <button onClick={createAndDownloadPowerPoint} className="w-full flex items-center justify-center space-x-2 px-4 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition-all duration-200 transform hover:scale-105">
                                    <ArrowDownTrayIcon className="h-5 w-5" /><span>Baixar PPTX Editado</span>
                                </button>
                            )}
                            {errorMessage && (<p className="mt-2 text-sm text-red-600 text-center font-medium">{errorMessage}</p>)}
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 p-4 lg:p-8 overflow-y-auto">
                        <div className="lg:hidden absolute top-4 left-4 z-40">
                            <button onClick={() => setIsSidebarOpen(true)} className="p-2 text-gray-600 bg-white rounded-lg shadow-md"><Bars3Icon className="h-6 w-6" /></button>
                        </div>
                        
                        {slides.length > 0 ? (
                            <div className="max-w-4xl mx-auto">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">Pr√©via da Apresenta√ß√£o</h2>
                                <p className="text-gray-600 mb-6">Revise e edite o conte√∫do abaixo. Suas altera√ß√µes ser√£o salvas no arquivo PPTX final.</p>
                                <div className="space-y-6">
                                    {slides.map((slide, index) => (
                                        <div key={index} className="bg-white p-6 rounded-lg shadow-md border border-gray-200 slide-fade-in flex flex-col gap-6" style={{ animationDelay: `${index * 100}ms`}}>
                                            <div className="flex flex-col md:flex-row gap-6">
                                                <div className="flex-1">
                                                    <label className="block text-sm font-bold text-indigo-700 mb-2">SLIDE {index + 1}: T√çTULO</label>
                                                    <input type="text" value={slide.title} onChange={(e) => handleSlideChange(index, 'title', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md text-lg font-semibold text-gray-800 focus:ring-2 focus:ring-indigo-500" />
                                                    <label className="block text-sm font-bold text-indigo-700 mt-4 mb-2">CONTE√öDO</label>
                                                    <textarea value={slide.content} onChange={(e) => handleSlideChange(index, 'content', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md text-gray-700 h-32 focus:ring-2 focus:ring-indigo-500" />
                                                </div>
                                                <div className="w-full md:w-1/3">
                                                    <label className="block text-sm font-bold text-indigo-700 mb-2">IMAGEM</label>
                                                    <div className="w-full h-40 bg-gray-200 rounded-md flex items-center justify-center">
                                                        {slide.imageData ? (
                                                            <img src={slide.imageData} alt={`Imagem para o slide ${slide.title}`} className="object-cover w-full h-full rounded-md" />
                                                        ) : (
                                                            <div className="flex flex-col items-center text-gray-500">
                                                                <PhotoIcon className="h-8 w-8 mb-2 animate-pulse" />
                                                                <span className="text-xs">Gerando imagem...</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="border-t border-gray-200 pt-4">
                                                <label className="block text-sm font-bold text-indigo-700 mb-2">NOTAS DO APRESENTADOR</label>
                                                <textarea value={slide.notes || ''} onChange={(e) => handleSlideChange(index, 'notes', e.target.value)} className="w-full p-2 border border-gray-300 rounded-md text-gray-600 text-sm h-24 focus:ring-2 focus:ring-indigo-500" placeholder="Suas notas para a apresenta√ß√£o..."/>
                                            </div>
                                            <div className="border-t border-gray-200 pt-4 flex items-center justify-between gap-2 flex-wrap">
                                                <span className="text-sm font-semibold text-gray-700">‚ú® Assistente IA:</span>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => refineSlideContent(index, 'conciso')} disabled={refiningState[index]} className="px-3 py-1 text-xs font-semibold text-purple-700 bg-purple-100 rounded-full hover:bg-purple-200 disabled:opacity-50">Conciso</button>
                                                    <button onClick={() => refineSlideContent(index, 'formal')} disabled={refiningState[index]} className="px-3 py-1 text-xs font-semibold text-blue-700 bg-blue-100 rounded-full hover:bg-blue-200 disabled:opacity-50">Formal</button>
                                                    <button onClick={() => refineSlideContent(index, 'inspirador')} disabled={refiningState[index]} className="px-3 py-1 text-xs font-semibold text-amber-700 bg-amber-100 rounded-full hover:bg-amber-200 disabled:opacity-50">Inspirador</button>
                                                    <button onClick={() => generatePresenterNotes(index)} disabled={refiningState[`notes-${index}`]} className="px-3 py-1 text-xs font-semibold text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 disabled:opacity-50 flex items-center gap-1">
                                                        {refiningState[`notes-${index}`] ? <span className="loader-sm"></span> : <PencilSquareIcon className="h-4 w-4" />}
                                                        Notas
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="flex items-center justify-center h-full">
                                <div className="text-center max-w-2xl mx-auto">
                                    <div className="mb-4 mt-6"><span className="inline-block bg-indigo-100 text-indigo-700 text-xs font-semibold px-3 py-1 rounded-full">Powered by Gemini AI</span></div>
                                    <h2 className="text-3xl lg:text-5xl font-extrabold text-gray-900 leading-tight">Transforme seu <span className="text-indigo-600">Projeto</span> em uma <span className="text-indigo-600">Apresenta√ß√£o de Impacto</span></h2>
                                    <p className="mt-6 text-base lg:text-lg text-gray-600">A pr√©via edit√°vel da sua apresenta√ß√£o aparecer√° aqui assim que for gerada.</p>
                                    
                                    <div className="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg text-left">
                                        <h4 className="font-bold text-blue-800">Dicas para o Melhor Resultado:</h4>
                                        <ul className="list-disc list-inside mt-2 text-sm text-blue-700 space-y-1">
                                            <li>Todo o texto e as imagens gerados pela IA s√£o <strong>sugest√µes</strong>. Edite-os na pr√©via para que fiquem perfeitos para o seu projeto.</li>
                                            <li>Para as fotos do projeto, recomendamos o envio de at√© <strong>10 imagens</strong> para um melhor resultado visual.</li>
                                            <li>Use uma logomarca com <strong>fundo transparente</strong> (.PNG). Se precisar, remova o fundo em sites como o <a href="https://www.remove.bg/pt-br" target="_blank" rel="noopener noreferrer" className="underline font-semibold">remove.bg</a>.</li>
                                            <li>O arquivo <strong>PPTX √© um ponto de partida</strong>. Pode ser necess√°rio fazer pequenos ajustes de layout diretamente no seu editor de apresenta√ß√µes preferido.</li>
                                        </ul>
                                    </div>

                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
